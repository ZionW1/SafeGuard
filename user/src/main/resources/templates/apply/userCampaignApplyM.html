<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>모바일 최적화 예시</title>
    <link rel="stylesheet" href="/mobile/css/style.css" />
</head>
<body>
    <div class="notice-box">
        확인 한번 해주세요!<br />
        예비자 목록 우측 버튼이 <span style="color:#3a00b4; font-weight:bold;">[선정]</span> 상태이면 선정된 
        상태이며, 누르게 되면 <span style="color:#3a00b4; font-weight:bold;">[미선정]</span>으로 변경되고, 미선정 상태가 됩니다.<br />
        * 반대의 경우도 동일
    </div>

    <div class="section">
        <!-- <h2 th:text="${userCampaignApply.campaignTitle}"></h2> -->
        <div id="campaignFileDownloadArea" th:data-campaign-id="${userCampaignApply[0].campaignId}">

            <h2 th:if="${userCampaignApply != null}" th:text="${userCampaignApply[0].campaignTitle}"></h2>
            <strong>당첨자</strong> <strong th:text="${userCampaignApply[0].applicantsNum}"></strong> / <strong th:text="${userCampaignApply[0].recruitmentNum}"></strong><br />
                <strong>담당자이름 : </strong><strong th:text="${userCampaignApply[0].companyNm}"></strong><br><strong> 담당자번호 : </strong><strong th:text="${userCampaignApply[0].companyPh}"></strong></p>
            <p><strong>체험단 방문기간</strong><br />
                <strong th:text="${userCampaignApply[0].eventPeriodStr}"></strong> ~ <strong th:text="${userCampaignApply[0].eventPeriodEnd}"></strong></p>
            <!-- <button class="btn-purple">모집글 확인</button> -->
        </div>
    </div>

    <div class="section">
        <div class="list-header">
            <span>예비자 목록</span>
            <span>1명</span>
        </div>

        <p>현재 사용자 ID: <span th:text="${userId}">guest</span></p>
        <div class="applicant-item">
            <div class="applicant-info">
                <div ></div>
                <div class="width100 mrg-b5 applicant-item" th:each="userCampaign : ${userCampaignApply}" th:data-applicant-user-no="${userCampaign.userNo}">
                        <img id="imgFile" th:src="|/selectProfile?id=${userCampaign.userNo}|" alt="파일이미지" width="50" height="50" />
                        <div style="margin-left: 55px; margin-top: -45px;">
                            <span class="userInfofont" th:text="${userCampaign.userNm}"></span>/<span class="userInfofont" th:text="${userCampaign.phoneNum}"></span><button class="btn-state mrg5">초기화</button>
                            <button class="btn-state"><span th:text="${userCampaign.statusNm}"></span></button>
                        </div>
                        <div class="btn-area" th:with="currentUserNo=${userCampaign.userNo}"> <!-- userCampaign 객체에서 userNo를 가져온다고 가정 -->
                            <!-- <a class="statusInfoChange" href="#" data-status="ATTEND" th:onclick="updateAttendanceStatus(this.dataset.status, [[${currentUserNo}]])">출근</a>
                            <a class="statusInfoChange" href="#" data-status="LEAVE" th:onclick="updateAttendanceStatus(this.dataset.status, [[${currentUserNo}]])">퇴근</a>
                            <a class="statusInfoChange" href="#" data-status="ABSENT" th:onclick="updateAttendanceStatus(this.dataset.status, [[${currentUserNo}]])">결근</a>
                            <a class="statusInfoChange" href="#" data-status="LATE" th:onclick="updateAttendanceStatus(this.dataset.status, [[${currentUserNo}]])">지각</a>
                            <a class="statusInfoChange" href="#" data-status="UNAUTHORIZED" th:onclick="updateAttendanceStatus(this.dataset.status, [[${currentUserNo}]])">무단</a> -->
                            <a class="statusInfoChange" href="#" data-status="1" th:onclick="updateAttendanceStatus(this.dataset.status, [[${currentUserNo}]])">출근</a>
                            <a class="statusInfoChange" href="#" data-status="2" th:onclick="updateAttendanceStatus(this.dataset.status, [[${currentUserNo}]])">퇴근</a>
                            <a class="statusInfoChange" href="#" data-status="3" th:onclick="updateAttendanceStatus(this.dataset.status, [[${currentUserNo}]])">지각</a>
                            <a class="statusInfoChange" href="#" data-status="4" th:onclick="updateAttendanceStatus(this.dataset.status, [[${currentUserNo}]])">결근</a>
                            <a class="statusInfoChange" href="#" data-status="5" th:onclick="updateAttendanceStatus(this.dataset.status, [[${currentUserNo}]])">무단</a>
                        </div>
                </div>

            </div>
        </div>
        
    </div>

    <div id="fileDownloadListSection" style="margin-top: 30px; padding: 15px; border-top: 1px solid #eee; display: none;">
        <h4><i class="fa fa-download" aria-hidden="true"></i> 다운로드 가능한 파일 목록</h4>
        <ul id="downloadLinksContainer" style="list-style: none; padding: 0;">
            <!-- JavaScript로 다운로드 링크들이 여기에 추가될 예정 -->
        </ul>
        <p id="noFilesMessage" style="color: #999; display: none;">다운로드할 파일이 없습니다.</p>
    </div>
    <div class="btn-area">
        <button class="btn-info" onclick="requestAllCampaignFilesDownload()">프로필 사진 다운로드</button>
        <th:block th:if="${userCampaignApply != null and not #lists.isEmpty(userCampaignApply) and userCampaignApply[0].campaignId != null}">
            <button class="btn-info" type="button" 
                    th:onclick="downloadExcel([[${userCampaignApply[0].campaignId}]])">
                엑셀 다운로드
            </button>
        </th:block>
        <th:block th:unless="${userCampaignApply != null and not #lists.isEmpty(userCampaignApply) and userCampaignApply[0].campaignId != null}">
            <!-- 엑셀 다운로드 불가 메시지 등을 표시할 수 있어 -->
            <p>엑셀 다운로드 불가 (캠페인 정보 없음)</p>
        </th:block>        <!-- <a th:href="@{/download/campaign/applications/excel/{campaignId}(campaignId=${userCampaignApply[0].campaignId})}"> 다운 </a> -->
    </div>
    
    <script th:inline="javascript">
        const csrfToken = /*[[${_csrf.token}]]*/ '';
        const csrfHeader = /*[[${_csrf.headerName}]]*/ '';

        async function requestAllCampaignFilesDownload() {
            // ⭐ 1. 화면에서 단일 캠페인 ID를 가져옴 ⭐
            const campaignFileDownloadArea = document.getElementById('campaignFileDownloadArea');
            if (!campaignFileDownloadArea) {
                alert('다운로드할 캠페인 정보를 찾을 수 없습니다.');
                return;
            }
            const campaignIdToDownload = Number(campaignFileDownloadArea.dataset.campaignId);

            console.log("서버로 보낼 캠페인 ID: ", campaignIdToDownload);

            if (isNaN(campaignIdToDownload) || campaignIdToDownload <= 0) {
                alert('유효한 캠페인 ID를 찾을 수 없습니다.');
                return;
            }

            try {
                // ⭐ 2. 단일 캠페인 ID를 POST 요청으로 전송 ⭐
                const response = await fetch('/file/download-campaign-zip', { // 새로운 엔드포인트 이름!
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(campaignIdToDownload) // 단일 ID를 JSON으로 보냄
                });

                if (!response.ok) {
                    if (response.status === 400) { alert('잘못된 요청입니다. 캠페인 ID가 전달되지 않았습니다.'); }
                    else if (response.status === 404) { alert('요청된 캠페인 또는 파일을 찾을 수 없습니다.'); }
                    else if (response.status === 500) { alert('서버 오류로 ZIP 파일 생성에 실패했습니다.'); }
                    else { alert(`파일 다운로드 요청 중 오류 발생: ${response.status}`); }
                    console.error('ZIP 다운로드 실패:', response.status, await response.text());
                    return;
                }

                const blob = await response.blob();
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `campaign_${campaignIdToDownload}_files.zip`; // 기본 파일명

                if (contentDisposition && contentDisposition.indexOf('filename=') !== -1) {
                    filename = contentDisposition.split('filename=')[1].split(';')[0].replace(/"/g, '');
                    try { filename = decodeURIComponent(filename); } catch (e) { console.warn('filename 디코딩 실패:', e); }
                }
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                alert('캠페인 파일들이 ZIP 형태로 다운로드됩니다.');

            } catch (error) {
                console.error('캠페인 ZIP 파일 다운로드 요청 중 오류 발생:', error);
                alert('캠페인 ZIP 파일 다운로드에 실패했습니다. 다시 시도해 주세요.');
            }
        }
        function downloadExcel(campaignId) {
            if (!campaignId) { // campaignId가 null이거나 정의되지 않았을 경우를 대비한 방어 코드
                console.error("캠페인 ID가 유효하지 않습니다.");
                alert("다운로드할 캠페인 ID가 올바르지 않습니다.");
                return;
            }
            
            // Thymeleaf 문법을 사용하지 않고 직접 JS에서 URL을 만드는 경우:
            const downloadUrl = `/download/campaign/applications/excel/${campaignId}`;
            
            // 이 URL로 브라우저를 이동시키면, 서버가 엑셀 파일을 반환하고 브라우저는 그 파일을 다운로드하게 돼.
            window.location.href = downloadUrl;
        }
        
        function updateAttendanceStatus(status, userNo) {
            if (!status || !userNo) {
                console.error("상태 또는 사용자 정보가 올바르지 않습니다.", {status: status, userNo: userNo});
                alert("상태 변경에 필요한 정보가 부족합니다. 다시 시도해 주세요.");
                return;
            }

            // 서버로 요청을 보낼 URL. Spring Controller의 엔드포인트에 맞춰줘!
            // 예시: /api/attendance/123/status
            const url = `/apply/attendance/${userNo}`; 

            fetch(url, {
                method: 'PATCH', // 상태 업데이트는 PATCH가 시맨틱적으로 더 적합하지만, PUT이나 POST를 써도 무방해.
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                    // 만약 스프링 시큐리티를 사용하고 있다면 CSRF 토큰도 헤더에 추가해야 할 수 있어.
                    // 'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                },
                body: JSON.stringify({ newStatus: status }) // 보낼 데이터 (새로운 상태 값)
            })
            .then(response => {
                // HTTP 응답 코드가 200번대(성공)가 아니면 에러로 처리
                if (!response.ok) { 
                    // 서버에서 보낸 에러 메시지를 JSON 형태로 파싱하여 처리
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || '상태 변경 중 알 수 없는 오류가 발생했습니다.');
                    });
                }
                return response.json(); // 성공 응답을 JSON 형태로 파싱
            })
            .then(data => {
                // 서버에서 응답받은 데이터 처리
                console.log('상태 변경 성공:', data);
                alert(`사용자 ${userNo}의 출결 상태가 '${status}'(으)로 변경되었습니다!`);
                
                // ✨ 여기서 화면 업데이트 로직을 추가해 줘! ✨
                // 예시: 해당 사용자 행의 상태를 변경하거나, 색깔을 바꾸거나, 페이지 새로고침 등
                // window.location.reload(); // 페이지 전체 새로고침
                
                // 예를 들어, 상태 변경된 <a> 태그에 스타일을 적용하는 경우:
                // 이 예시에서는 모든 버튼의 스타일을 초기화하고 현재 클릭된 버튼만 활성화
                const buttons = document.querySelectorAll(`a[th-onclick$=", [[${userNo}]])"]`); // 동일 userNo의 버튼 찾기
                buttons.forEach(btn => btn.classList.remove('active-status'));
                event.target.classList.add('active-status'); // 클릭된 버튼에 'active-status' 클래스 추가

            })
            .catch(error => {
                console.error('상태 변경 중 오류 발생:', error);
                alert('상태 변경에 실패했습니다: ' + error.message);
            });
        }
    </script>
</body>
</html>