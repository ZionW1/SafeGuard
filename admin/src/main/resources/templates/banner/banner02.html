<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <th:block th:replace="~{fragments/csrfFragments :: metaCsrf}"></th:block>

    <link rel="stylesheet" th:href="@{/css/style.css}" />
  <title>ì „ì²´ ë°°ë„ˆ ëª©ë¡</title>
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        h3 {
            font-size: 28px;
            margin-bottom: 24px;
        }
        .form-item {
            margin-bottom: 20px;
        }
        .field-label {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }
        .text-field {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            font-family: 'Pretendard', sans-serif;
        }
        .help-text {
            font-size: 13px;
            color: #637381;
            margin-top: 4px;
        }
        .upload-container {
            display: flex;
            flex-direction: column;
        }
        .upload-box {
            width: 90%;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .upload-box:hover {
            border-color: #1976d2;
        }
        .preview-image {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            display: none;
        }
        .button-container {
            width: 100%;
            display: flex;
            justify-content: flex-end;
        }
        .submit-button {
            width: 10rem;
            height: 3rem;
            font-size: 1.05rem;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .submit-button:hover {
            background-color: #1565c0;
        }
    </style>
</head>
<body>
<div class="admin-container">
    <div th:replace="~{fragments/sidebar :: sidebarFragment}"></div>

    <div class="main-content">
        <h1>  <a th:href="@{/banner02(id=${bannerSelect.bannerId}, targetType='banner')}">ë°°ë„ˆ ìˆ˜ì •</a>
        </h1>
        <form class="form" id="banner-form" th:action="@{/banner02}" method="post" enctype="multipart/form-data">
            <th:block th:replace="fragments/csrfFragments :: inputCsrf"></th:block>

            <input type="hidden" name="bannerId" th:value="${bannerSelect.bannerId}"/>
            <div class="form-item">
                <label class="field-label">ë°°ë„ˆëª…</label>
                <input type="text" class="text-field" name="title" id="title" placeholder="ë°°ë„ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”." th:value="${bannerSelect.title}" required>
            </div>

            <div class="form-item">
                <label class="field-label">URL ì…ë ¥</label>
                <input type="url" class="text-field" name="url" id="url" placeholder="ì˜ˆ) https://www.naver.com" th:value="${bannerSelect.url}" required>
            </div>

            <div class="form-group">
                <div class="form-group">
                    <label>ë°°ë„ˆ ì´ë¯¸ì§€</label>
                    <div id="existing-file-section" th:classappend="${file == null} ? 'hidden'">
                        <div class="mrg_auto">
                            <img id="imgFile" th:src="@{|/banner/img?id=${bannerSelect.bannerId}|}" alt="íŒŒì¼ì´ë¯¸ì§€" width="720" height="405" />
                        </div>
                        <button type="button" style="margin-top: 10px; background-color: #aaa; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;"
                                th:onclick="bannerRemoveFile(this, [[${bannerSelect.bannerId}]])">ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ</button>
                    </div>
                    <div class="upload-box" id="upload-box" th:classappend="${file != null} ? 'hidden'" style="border: 2px dashed #b594ff; padding: 20px; text-align: center; border-radius: 8px;">
                        <p>ì´ë¯¸ì§€ë¥¼ ì—¬ê¸°ì— ëŒì–´ë‹¤ ë†“ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                        <div>
                            <input type="file" name="file" id="file" accept="image/*" width="720" height="405" style="display: none;">
                            <!-- <img id="preview-image" class="preview-image" alt="ë°°ë„ˆ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°"> -->
                            <img id="preview-image" class="preview-image" th:src="@{|/banner/img?id=${bannerSelect.bannerId}|}" alt="íŒŒì¼ì´ë¯¸ì§€" width="720" height="405" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- <div class="form-item">
                <label class="field-label">ë°°ë„ˆ ì‚¬ì§„*</label>
            

                <div class="upload-container">
                    <div class="upload-box" id="upload-box">
                        <p>ì´ë¯¸ì§€ë¥¼ ì—¬ê¸°ì— ëŒì–´ë‹¤ ë†“ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                        <input type="file" name="file" id="file" accept="image/*" width="720" height="405" style="display: none;">
                        <img id="preview-image" class="preview-image" alt="ë°°ë„ˆ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°">
                        <img id="imgFile" th:src="@{|/banner/img?id=${bannerSelect.bannerId}|}" alt="íŒŒì¼ì´ë¯¸ì§€" width="720" height="405" />

                    </div>
                    <p class="help-text">ë°°ë„ˆ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”</p>
                </div>
            </div> -->

            <div class="button-container">
                <button type="submit" class="submit-button">ìˆ˜ì •</button>
            </div>
        </form>
    </div>
</div>

<script>
    // íŒŒì¼ ì—…ë¡œë“œ ê´€ë ¨ ê¸°ëŠ¥
    const uploadBox = document.getElementById('upload-box');
    const fileInput = document.getElementById('file');
    const previewImage = document.getElementById('preview-image');
    let bannerImage = "";
    
    // í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ ì°½ ì—´ê¸°
    uploadBox.addEventListener('click', () => {
        fileInput.click();
    });
    
    // íŒŒì¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥
    uploadBox.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadBox.style.borderColor = '#1976d2';
    });
    
    uploadBox.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadBox.style.borderColor = '#ccc';

        if (e.dataTransfer.files.length) {
            handleFile(e.dataTransfer.files[0]);
        }
    });
    
    // íŒŒì¼ ì„ íƒ ì‹œ ì²˜ë¦¬
    fileInput.addEventListener('change', (e) => {
        console.log(e.target.files.length);
        if (e.target.files.length) {
            handleFile(e.target.files[0]);
        }
    });
    
    // íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
    function handleFile(file) {
        if (file && file.type.startsWith('image/')) {
            document.getElementById('imgFile').style.display = 'none';
            bannerImage = file;
            
            // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewImage.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }

    function bannerRemoveFile(element, id){
        console.log("campaign: " + id);
        let request = new XMLHttpRequest();

        // â­ï¸ CSRF í† í° ê°€ì ¸ì˜¤ê¸° ì‹œì‘ â­ï¸
        // hidden input íƒœê·¸ì—ì„œ nameê³¼ valueë¥¼ ê°€ì ¸ì™€.
        const csrfToken = document.querySelector('input[name="_csrf"]').value;
        // const csrfHeader = document.querySelector('input[name="_csrf"]').name; // ìŠ¤í”„ë§ ê¸°ë³¸ì€ "_csrf"ì•¼
        const csrfHeaderToSend = "X-CSRF-TOKEN"; // ğŸ‘ˆ Spring Securityê°€ ê¸°ë³¸ìœ¼ë¡œ ê¸°ëŒ€í•˜ëŠ” í—¤ë” ì´ë¦„!
        // ë§Œì•½ parameterNameì´ ë‹¤ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´, ë‹¤ìŒê³¼ ê°™ì´ë„ ê°€ëŠ¥í•´:
        // const csrfHeader = document.querySelector('input[name="_csrf"]').getAttribute('name');

        // meta íƒœê·¸ë¡œ CSRF í† í°ì„ ì €ì¥í–ˆë‹¤ë©´ ì´ë ‡ê²Œ ê°€ì ¸ì˜¬ ìˆ˜ë„ ìˆì–´:
        // const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
        // const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");
        // â­ï¸ CSRF í† í° ê°€ì ¸ì˜¤ê¸° ë â­ï¸
        request.onreadystatechange = function(){
            if(request.readyState == request.DONE && request.status == 200) {
                let response = request.responseText;
                if(response == 'SUCCESS'){
                    alert('íŒŒì¼ ì‚­ì œ(ìƒíƒœ ë³€ê²½) ì„±ê³µ');

                            // â­ï¸ í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¹ì…˜ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸° â­ï¸
                            document.getElementById("existing-file-section").classList.add('hidden');    // ê¸°ì¡´ íŒŒì¼ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                            document.getElementById("upload-box").classList.remove('hidden');             // ë“œë¡­ ì˜ì—­ ë³´ì´ê¸°

                            // ì´ë¯¸ì§€ ì—…ë¡œë“œ <input> íƒœê·¸ì˜ ê°’ì„ ë¹„ì›Œì„œ íŒŒì¼ ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
                            document.getElementById("file").value = '';
                            // ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ë„ ì´ˆê¸° ìƒíƒœë¡œ (src ë¹„ìš°ê³  hidden í´ë˜ìŠ¤ ì¶”ê°€í•˜ì—¬ ìˆ¨ê¹€)
                            document.getElementById("preview").classList.add('hidden'); // ë¯¸ë¦¬ë³´ê¸° img íƒœê·¸ ìˆ¨ê¸°ê¸°
                            document.getElementById("preview").src = ""; // ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ src ë¹„ìš°ê¸°

                }else{
                    alert('íŒŒì¼ ì‚­ì œ(ìƒíƒœ ë³€ê²½) ì‹¤íŒ¨');
                }
            } else if (request.readyState == request.DONE && request.status != 200) {
                alert('íŒŒì¼ ì‚­ì œ(ìƒíƒœ ë³€ê²½) ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + request.responseText);
            }
        }

        const url = `/admin/bannerRemoveFile?id=${id}`;
        console.log("mark deleted url : " + url);
        request.open('POST', url, true);
        request.setRequestHeader(csrfHeaderToSend, csrfToken);
        request.send();
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ì‘ì—…
    document.addEventListener('DOMContentLoaded', () => {
        // í•„ìš”í•œ ì´ˆê¸°í™” ì‘ì—…ì´ ìˆë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€
        console.log('ë°°ë„ˆ ìƒì„¸ë³´ê¸° í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
    });
</script>
</body>
</html>