<div th:fragment="mypageSidebarMenu">
    <aside class="sidebar">
        <nav>
            <div class="sr-only">
            <!-- <form class="profile-preview" action="/updateProfile" method="post" enctype="multipart/form-data">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="id" id="id" th:value="${userId}" />
                <input type="hidden" name="userId" id="userId" th:value="${username}" />
                <p>í˜„ì¬ ì‚¬ìš©ì ID: <span th:text="${username}">guest</span></p>

                <div class="profile">
                    <div id="drop-area" style="border: 2px dashed #b594ff; padding: 20px; text-align: center; border-radius: 8px">
                        <input type="file" name="image" id="image" accept="image/*" style="display: none" />
                        <div id="imageDisplayArea">
                            <img id="preview" src="" alt="ë¯¸ë¦¬ë³´ê¸°" style="max-width: 100%; margin: 0px auto; display: none;" />
                            <img th:if="${file != null}" id="imgFile" th:src="|/selectProfile?id=${userId}&args=1|" alt="íŒŒì¼ì´ë¯¸ì§€" width="720" height="405" style="max-width: 100%; margin: 0px auto;" />
                            <img th:if="${file == null}" id="defaultImage" src="/images/not-image.png" alt="ê¸°ë³¸ ì´ë¯¸ì§€" style="max-width: 100%; margin: 0px auto;" />
                        </div>
                    </div>
                    <div th:if="${file != null}" class="file-action-buttons">
                        <button type="button" style="margin-top: 10px; background-color: #aaa; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;"
                                th:onclick="markFileDeleted([[${userId}]]);">ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ</button>
                    </div>
                    <p><span sec:authentication=""></span></p>
                </div>
                <div th:if="${file == null}" class="file-action-buttons">
                            <button class="profile_save" type="submit">í”„ë¡œí•„ ì‚¬ì§„ ì €ì¥í•˜ê¸°</button>
                </div>
            </form> -->
            
            <div id="existing-file-section" th:if="${file != null} ? 'hidden'" style="max-width: 100%; margin: 0px auto; ">
                <div class="imageDisplayArea">
                    <img id="preview" src="" alt="ë¯¸ë¦¬ë³´ê¸°" style="max-width: 100%; margin: 0px auto; display: none;" />
                    <img th:if="${file != null}" id="imgFile" th:src="|/selectProfile?id=${userId}&args=1|" alt="íŒŒì¼ì´ë¯¸ì§€" width="720" height="405" style="max-width: 100%; margin: 0px auto;" />
                    <img th:if="${file == null}" id="defaultImage" src="/images/not-image.png" alt="ê¸°ë³¸ ì´ë¯¸ì§€" style="max-width: 100%; margin: 0px auto;" />
                </div>
                <button type="button" style="margin-top: 10px; background-color: #aaa; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;"
                        th:onclick="markFileDeleted([[${userId}]])">ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ</button>
            </div>
            
            <!-- â­ï¸ íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­: ID ì¶”ê°€ ë° hidden í´ë˜ìŠ¤ ì¡°ê±´ë¶€ ì¶”ê°€ â­ï¸ -->
            <!-- file ê°ì²´ê°€ nullì´ ì•„ë‹ˆë©´ hidden í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•´ì„œ ìˆ¨ê¸°ê³ , nullì´ë©´ hidden í´ë˜ìŠ¤ ì—†ì´ ë³´ì—¬ì¤Œ -->
            <form class="profile-preview" action="/updateProfile" method="post" enctype="multipart/form-data">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="id" id="id" th:value="${userId}" />
                <input type="hidden" name="userId" id="userId" th:value="${username}" />
                

                <div th:unless="${file != null} ? 'hidden'">
                    <div id="drop-area" style="border: 2px dashed #b594ff; padding: 20px; text-align: center; border-radius: 8px;">
                        <p>ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”</p>
                        <div>
                            <input type="file" name="image" id="image" accept="image/*" style="display: none" />
                            <img th:if="${file == null}" id="defaultImage" src="/images/not-image.png" alt="ê¸°ë³¸ ì´ë¯¸ì§€" style="max-width: 100%; margin: 0px auto;" />

                            <!-- â­ï¸ ì—¬ê¸° hidden í´ë˜ìŠ¤ ì¶”ê°€ â­ï¸ -->
                            <img id="preview" src="" alt="ë¯¸ë¦¬ë³´ê¸°" class="hidden" style="max-width: 100%; margin-top: 10px;" />
                        </div>
                    </div>
                    <button class="profile_save" type="submit">í”„ë¡œí•„ ì‚¬ì§„ ì €ì¥í•˜ê¸°</button>
                </div>

            </form>

        </div>
        <div class="mypage-menu">
            <h3 class="sidebar-title">ê³ ê°ì„¼í„°</h3>
            
            <ul class="sidebar-menu">
                <!-- <li class="menu-item" th:classappend="${currentURI.startsWith('/notice01')} ? 'active' : ''">
                    <a href="/notice01">ê³µì§€ì‚¬í•­</a>
                </li> -->
                <li class="menu-item" th:classappend="${(currentURI.startsWith('/mypage/calendarPage')) ? 'active' : ''}">
                    <a href="/mypage/calendarPage">ê²½í˜¸ ìº˜ë¦°ë”</a></li>
                <li class="menu-item" th:classappend="${currentURI.startsWith('/mypage/infoUpdate')} ? 'active' : ''">
                    <a href="/mypage/infoUpdate">ë‚´ ì •ë³´</a>
                </li>
                <li class="menu-item" th:classappend="${currentURI.startsWith('/mypage/point')} ? 'active' : ''">
                    <a href="/mypage/point">í¬ì¸íŠ¸ ë‚´ì—­</a>
                </li>
                <li class="menu-item" th:classappend="${currentURI.startsWith('/mypage/changePasswordPage')} ? 'active' : ''">
                    <a href="/mypage/changePasswordPage">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</a>
                </li>
                <!-- <li class="menu-item" th:classappend="${currentURI.startsWith('/useGuide01')} ? 'active' : ''">
                    <a href="/useGuide01">ì´ìš©ê°€ì´ë“œ</a>
                </li> -->
            </ul>
        </div>
        </nav>
    </aside>
    <script th:inline="javascript">
    const dropArea = document.getElementById("drop-area");
    const imageInput = document.getElementById("image"); // â­ id="image"ë¡œ ë³€ê²½ë¨ â­
    const preview = document.getElementById("preview");
    const defaultImage = document.getElementById("defaultImage"); // ìƒˆë¡œ ì¶”ê°€ëœ ê¸°ë³¸ ì´ë¯¸ì§€
    // ì˜ˆ: ë²„íŠ¼ í´ë¦­ ë“± ì´ë²¤íŠ¸ì— ì—°ê²°í•˜ì—¬ í˜¸ì¶œ
    const csrfHeaderToSend = "X-CSRF-TOKEN"; // ğŸ‘ˆ Spring Securityê°€ ê¸°ë³¸ìœ¼ë¡œ ê¸°ëŒ€í•˜ëŠ” í—¤ë” ì´ë¦„!

    // ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ìˆ¨ê¸°ê³ , ì—†ìœ¼ë©´ ë³´ì—¬ì£¼ê¸°
    if (defaultImage && imageInput.files.length === 0) { // defaultImageê°€ ìˆê³  ì•„ì§ ì„ íƒëœ íŒŒì¼ì´ ì—†ìœ¼ë©´
        defaultImage.style.display = 'block';
        preview.style.display = 'none';
        // imgFile (ê¸°ì¡´ ì´ë¯¸ì§€)ë„ íŒŒì¼ ì—†ìœ¼ë©´ ìˆ¨ê¸°ê¸°
        const imgFile = document.getElementById("imgFile");
        if (imgFile) imgFile.style.display = 'none';
    }

    dropArea.addEventListener("click", () => imageInput.click()); // í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒì°½ ì—´ë¦¼

    // ë“œë˜ê·¸ ì˜¤ë²„ / ë“œë˜ê·¸ ë¦¬ë¸Œ / ë“œë¡­ ì´ë²¤íŠ¸ (ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ)
    dropArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropArea.style.backgroundColor = "#f3e7ff";
    });
    dropArea.addEventListener("dragleave", () => {
        dropArea.style.backgroundColor = "transparent";
    });
    dropArea.addEventListener("drop", (e) => {
        e.preventDefault();
        dropArea.style.backgroundColor = "transparent";
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith("image/")) {
            imageInput.files = e.dataTransfer.files; // ë“œë¡­ëœ íŒŒì¼ì„ inputì— ì„¤ì •
            showPreview(file);
        }
    });

    // input ê°’ì´ ë³€ê²½ë  ë•Œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    imageInput.addEventListener("change", () => {
        const file = imageInput.files[0];
        if (file) {
            showPreview(file);
        } else {
            // íŒŒì¼ ì„ íƒì´ ì·¨ì†Œë˜ê±°ë‚˜ íŒŒì¼ì´ ì—†ì„ ë•Œ ì²˜ë¦¬ (ê¸°ì¡´ ì´ë¯¸ì§€ ë˜ëŠ” ê¸°ë³¸ ì´ë¯¸ì§€ ë³µêµ¬)
            preview.style.display = 'none';
            // ì—¬ê¸°ì„œëŠ” `file` ë³€ìˆ˜ì— ë”°ë¼ `imgFile` ë˜ëŠ” `defaultImage`ë¥¼ ë‹¤ì‹œ ë³´ì—¬ì£¼ëŠ” ë¡œì§ì´ í•„ìš”í•´.
            // Thymeleafì˜ ${file != null} ê°’ì€ JSì—ì„œ ì§ì ‘ ì ‘ê·¼í•˜ê¸° ì–´ë ¤ìš°ë¯€ë¡œ,
            // ë Œë”ë§ ì‹œì ì— JS ë³€ìˆ˜ì— í• ë‹¹í•˜ê±°ë‚˜, HTMLì—ì„œ í˜„ì¬ ìƒíƒœë¥¼ ë‚˜íƒ€ë‚´ëŠ” data-* ì†ì„± ë“±ì„ í™œìš©í•˜ëŠ” ê²Œ ì¢‹ì•„.
            // ì˜ˆë¥¼ ë“¤ì–´ <div id="imageDisplayArea" data-has-initial-image="${file != null}"></div>
            // JSì—ì„œ ì´ data-has-initial-image ê°’ì„ ì½ì–´ì„œ ì²˜ë¦¬
        }
    });

    // ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜
    function showPreview(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            // ìƒˆ ì´ë¯¸ì§€ê°€ ì„ íƒë˜ì—ˆìœ¼ë‹ˆ ê¸°ì¡´ ì´ë¯¸ì§€ë‚˜ ê¸°ë³¸ ì´ë¯¸ì§€ëŠ” ìˆ¨ê¹€
            const imgFile = document.getElementById("imgFile");
            if (imgFile) imgFile.style.display = 'none';
            if (defaultImage) defaultImage.style.display = 'none';

            preview.src = e.target.result;
            preview.style.display = "block";
        };
        reader.readAsDataURL(file);
    }

    // ë¹„ë™ê¸° íŒŒì¼ ì‚­ì œ ìš”ì²­ í•¨ìˆ˜ (async/await ì‚¬ìš©)
    async function markFileDeleted(id) {
        const csrfToken = document.querySelector('input[name="_csrf"]').value;
        const url = `/mypage/markDeleted/${id}`;
        console.log("mark deleted url : " + url);

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    [csrfHeaderToSend]: csrfToken
                }
            });

            // ìƒíƒœê°€ 200ì¼ ë•Œë§Œ ì²˜ë¦¬
            if (response.ok) {
                const text = await response.text();
                if (text === 'SUCCESS') {
                    alert('íŒŒì¼ ì‚­ì œ(ìƒíƒœ ë³€ê²½) ì„±ê³µ');
                    window.location.reload();


                    // preview.src = "";
                } else {
                    alert('íŒŒì¼ ì‚­ì œ(ìƒíƒœ ë³€ê²½) ì‹¤íŒ¨');
                }
            } else {
                const errorText = await response.text();
                alert('íŒŒì¼ ì‚­ì œ(ìƒíƒœ ë³€ê²½) ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + errorText);
            }
        } catch (error) {
            // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“± ì˜ˆì™¸ ì²˜ë¦¬
            alert('íŒŒì¼ ì‚­ì œ ìš”ì²­ ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }

    function removeFile(element, id){
                console.log("removeFile: " + id);
                let request = new XMLHttpRequest();

                
                // â­ï¸ CSRF í† í° ê°€ì ¸ì˜¤ê¸° ì‹œì‘ â­ï¸
                // hidden input íƒœê·¸ì—ì„œ nameê³¼ valueë¥¼ ê°€ì ¸ì™€.
                const csrfToken = document.querySelector('input[name="_csrf"]').value;
                // const csrfHeader = document.querySelector('input[name="_csrf"]').name; // ìŠ¤í”„ë§ ê¸°ë³¸ì€ "_csrf"ì•¼
                const csrfHeaderToSend = "X-CSRF-TOKEN"; // ğŸ‘ˆ Spring Securityê°€ ê¸°ë³¸ìœ¼ë¡œ ê¸°ëŒ€í•˜ëŠ” í—¤ë” ì´ë¦„!
                // ë§Œì•½ parameterNameì´ ë‹¤ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´, ë‹¤ìŒê³¼ ê°™ì´ë„ ê°€ëŠ¥í•´:
                // const csrfHeader = document.querySelector('input[name="_csrf"]').getAttribute('name');

                // meta íƒœê·¸ë¡œ CSRF í† í°ì„ ì €ì¥í–ˆë‹¤ë©´ ì´ë ‡ê²Œ ê°€ì ¸ì˜¬ ìˆ˜ë„ ìˆì–´:
                // const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
                // const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");
                // â­ï¸ CSRF í† í° ê°€ì ¸ì˜¤ê¸° ë â­ï¸
                request.onreadystatechange = function(){
                    if(request.readyState == request.DONE && request.status == 200) {
                        let response = request.responseText;
                        if(response == 'SUCCESS'){
                            alert('íŒŒì¼ ì‚­ì œ(ìƒíƒœ ë³€ê²½) ì„±ê³µ');

                            // â­ï¸ í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¹ì…˜ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸° â­ï¸
                            document.getElementById("existing-file-section").classList.add('hidden');    // ê¸°ì¡´ íŒŒì¼ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                            document.getElementById("drop-area").classList.remove('hidden');             // ë“œë¡­ ì˜ì—­ ë³´ì´ê¸°

                            // ì´ë¯¸ì§€ ì—…ë¡œë“œ <input> íƒœê·¸ì˜ ê°’ì„ ë¹„ì›Œì„œ íŒŒì¼ ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
                            document.getElementById("image").value = '';
                            // ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ë„ ì´ˆê¸° ìƒíƒœë¡œ (src ë¹„ìš°ê³  hidden í´ë˜ìŠ¤ ì¶”ê°€í•˜ì—¬ ìˆ¨ê¹€)
                            document.getElementById("preview").classList.add('hidden'); // ë¯¸ë¦¬ë³´ê¸° img íƒœê·¸ ìˆ¨ê¸°ê¸°
                            document.getElementById("preview").src = ""; // ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ src ë¹„ìš°ê¸°

                        }else{
                            alert('íŒŒì¼ ì‚­ì œ(ìƒíƒœ ë³€ê²½) ì‹¤íŒ¨');
                        }
                    } else if (request.readyState == request.DONE && request.status != 200) {
                        alert('íŒŒì¼ ì‚­ì œ(ìƒíƒœ ë³€ê²½) ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + request.responseText);
                    }
                }

                const url = `/mypage/markDeleted/${id}`;
                console.log("mark deleted url : " + url);
                request.open('POST', url, true);
                request.setRequestHeader(csrfHeaderToSend, csrfToken);
                request.send();
            }

    // ì´ˆê¸° ë¡œë“œ ì‹œ ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ previewì™€ imgFileì„ ì ì ˆíˆ ì„¤ì •
    // ì´ê±´ DOMContentLoaded ì•ˆì—ì„œ ì²˜ë¦¬í•˜ëŠ” ê²Œ ì¢‹ì•„.
    document.addEventListener("DOMContentLoaded", function() {
        const initialImgFile = document.getElementById("imgFile");
        const initialPreview = document.getElementById("preview");
        const initialDefaultImage = document.getElementById("defaultImage");

        if (initialImgFile) { // ê¸°ì¡´ íŒŒì¼ì´ ìˆì—ˆìœ¼ë©´
            initialImgFile.style.display = 'block';
            initialPreview.style.display = 'none';
            if (initialDefaultImage) initialDefaultImage.style.display = 'none';
        } else { // ê¸°ì¡´ íŒŒì¼ì´ ì—†ì—ˆìœ¼ë©´ ê¸°ë³¸ ì´ë¯¸ì§€
            if (initialDefaultImage) initialDefaultImage.style.display = 'block';
            initialPreview.style.display = 'none';
        }
    });
    </script>
</div>