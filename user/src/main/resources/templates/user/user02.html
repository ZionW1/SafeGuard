<!-- ğŸ“‚ ê²½ë¡œ: register/register.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>íšŒì›ê°€ì…</title>
    <!-- <link rel="stylesheet" href="/css/createMember.css" /> -->
    <link rel="stylesheet" href="/css/login.css">

</head>
<body>
<div class="register-container">
    <h2>íšŒì›ê°€ì…</h2>
    <form id="registerForm" class="" th:action="@{/user02}" method="post" th:object="${userVO}">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <div class="form-group">
            <input type="text" name="userNm" id="userNm" th:field="*{userNm}" placeholder="ì´ë¦„" required />
        </div>

        <div class="form-group phone-group">
            <!-- <input type="tel" name="phoneNum" id="phoneNum" th:field="*{phoneNum}" placeholder="íœ´ëŒ€í° ë²ˆí˜¸" required />
            <button type="button" class="" id="sendAuth">ë³¸ì¸ì¸ì¦</button>
            <div id="phoneStatus" style="font-size: 12px; margin-top: 4px;"></div> -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <input type="text" id="phoneNumber" name="phoneNumber" placeholder="01012345678" required pattern="\d{10,11}" />
                <!-- <button type="submit" id="sendCode" style="width:100px">ì¸ì¦ë²ˆí˜¸ ë°œì†¡</button> -->
                <button type="button" id="sendBtn">ì¸ì¦ë²ˆí˜¸ ë°œì†¡</button>
        </div>

        <div class="form-group auth-group hidden" id="authCodeGroup">
            <!-- <input type="text" name="authCode" id="authCode" th:field="*{authCode}" placeholder="ì¸ì¦ë²ˆí˜¸ ì…ë ¥" />
            <button type="button" class="verifyAuth" id="verifyAuth">ì¸ì¦í•˜ê¸°</button> -->

            <div id="authSection">
                <input type="text" id="authCode" placeholder="ì¸ì¦ë²ˆí˜¸ 6ìë¦¬ ì…ë ¥">
                <span id="timer">03:00</span>
                <button type="button" id="verifyBtn">ì¸ì¦í™•ì¸</button>
            </div>

            <p id="resultMessage"></p>
        </div>

        <div class="form-group">
            <input type="email" name="email" id="email" th:field="*{email}" placeholder="ì´ë©”ì¼" required />
            <div id="emailStatus" style="font-size: 12px; margin-top: 4px;"></div>
        </div>

        <div class="form-group">
            <input type="text" name="userId" id="userId" th:field="*{userId}" placeholder="ì•„ì´ë”” (6ì ì´ìƒ)" minlength="6" required />
            <div id="usernameStatus" style="font-size: 12px; margin-top: 4px;"></div>
        </div>

        <!-- <div class="form-group">
            <input type="password" name="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required />
            <div id="pwHint" class="password-guide">
            ë¹„ë°€ë²ˆí˜¸ëŠ” <span class="font-red"><strong>ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì í¬í•¨ 8ì ì´ìƒ</strong></span>ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
            </div>
        </div>

        <div class="form-group">
            <input type="password" name="confirmPassword" id="confirmPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" required />
            <div id="passwordMatchStatus" style="font-size: 12px; margin-top: 4px;"></div>
        </div> -->
        <div class="form-group">
            <div class="password-input-container">
                <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required />
                <span class="password-toggle" onclick="togglePasswordVisibility('password')">ğŸ‘ï¸</span>
                <!-- ğŸ‘ï¸ ì´ ì´ëª¨ì§€ ëŒ€ì‹  Font Awesome ì•„ì´ì½˜ (ì˜ˆ: <i class="far fa-eye"></i>) ë“±ì„ ì‚¬ìš©í•´ë„ ì¢‹ì•„! -->
            </div>
            <div class="error-msg" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></div>
        </div>
        
        <div class="form-group">
            <div class="password-input-container">
                <label for="passwordConfirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" id="passwordConfirm" name="passwordConfirm" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”" required />
                <span class="password-toggle" onclick="togglePasswordVisibility('passwordConfirm')">ğŸ‘ï¸</span>
            </div>
            <div class="error-msg" th:if="${#fields.hasErrors('passwordConfirm')}" th:errors="*{passwordConfirm}"></div>
        </div>


        <div class="form-group">
            <input type="text" name="referrerId" id="referrerId" placeholder="ì¶”ì²œì¸ ì•„ì´ë”” (ì„ íƒ)" />
        </div>

        <button type="submit">íšŒì›ê°€ì… ì‹ ì²­</button>
    </form>


    

    <p class="login-link">
        <a href="/user01" class="back-to-login">â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </p>
    <p class="login-link">
        <a href="/" class="back-to-login">ë©”ì¸ í™ˆí˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
    </p>
</div>

<script>
    // const sendAuth = document.getElementById('sendAuth');
    // const authCodeGroup = document.getElementById('authCodeGroup');

    // sendAuth.addEventListener('click', () => {
    //     // ë³¸ì¸ì¸ì¦ ì‹œì‘ í´ë¦­ ì‹œ ì¸ì¦ë²ˆí˜¸ ì…ë ¥ë€ ë³´ì´ê¸°
    //     authCodeGroup.classList.remove('hidden');

    //     // í•„ìš”í•˜ë©´ ë²„íŠ¼ ë¹„í™œì„±í™” ë“± ì¶”ê°€ ë™ì‘ ê°€ëŠ¥
    //     sendAuth.disabled = true;
    //     sendAuth.textContent = 'ë³¸ì¸ì¸ì¦ ì§„í–‰ ì¤‘...';
    // });

    // document.getElementById('verifyAuth').addEventListener('click', function() {
    //     const phone = document.getElementById('phoneInput').value;
    //     if (!phone) {
    //         alert('ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    //         return;
    //     }
    //     // 1) ì¸ì¦ë²ˆí˜¸ ì „ì†¡ ìš”ì²­ (ì„œë²„/APIë¡œ Ajax í˜¸ì¶œ ë“±)
    //     sendAuthCode(phone).then(() => {
    //         // 2) ì¸ì¦ë²ˆí˜¸ ì…ë ¥ë€ í™œì„±í™”
    //         document.getElementById('authCodeArea').style.display = 'block';
    //         // ìƒíƒœ ë©”ì‹œì§€, ë²„íŠ¼ ë¹„í™œì„±í™” ë“± ì²˜ë¦¬
    //     }).catch(() => {
    //         alert('ì¸ì¦ë²ˆí˜¸ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    //     });
    // });

    function togglePasswordVisibility(fieldId) {
            const passwordField = document.getElementById(fieldId);
            const toggleButton = passwordField.nextElementSibling; // ë°”ë¡œ ë‹¤ìŒ í˜•ì œ ìš”ì†Œ (ğŸ‘ï¸ ë²„íŠ¼)

            if (passwordField.type === "password") {
                passwordField.type = "text"; // ë¹„ë°€ë²ˆí˜¸ ë³´ì´ê²Œ
                toggleButton.textContent = "ğŸ”’"; // ì•„ì´ì½˜ ë³€ê²½ (ì„ íƒ ì‚¬í•­)
            } else {
                passwordField.type = "password"; // ë¹„ë°€ë²ˆí˜¸ ìˆ¨ê¸°ê²Œ
                toggleButton.textContent = "ğŸ‘ï¸"; // ì•„ì´ì½˜ ë³€ê²½ (ì„ íƒ ì‚¬í•­)
            }
        }
</script>

<script th:inline="javascript">
    const form = document.getElementById('smsForm');
    const resultMessage = document.getElementById('resultMessage');
    const sendBtn = document.getElementById('sendBtn');
    const csrfHeader = /*[[${_csrf.headerName}]]*/ ''; // ì˜ˆ: 'X-CSRF-TOKEN' ë˜ëŠ” ë¹ˆ ë¬¸ìì—´
    const csrfToken = /*[[${_csrf.token}]]*/ '';       // ì‹¤ì œ í† í° ê°’ ë˜ëŠ” ë¹ˆ ë¬¸ìì—´

    const requestHeaders = {};

    if (csrfHeader && csrfToken) {
        requestHeaders[csrfHeader] = csrfToken;
    }

    sendBtn.addEventListener('click', function() {
        const phoneNumber = document.getElementById('phoneNumber').value;

        if(!phoneNumber) {
            alert("ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        
        fetch('/auth/sendCode', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                ...requestHeaders  // ë°˜ë“œì‹œ ê°ì²´ ë³‘í•© í˜•íƒœë¡œ ì¶”ê°€
            },
            credentials: 'include',  // ì´ ì˜µì…˜ì´ ì¤‘ìš”í•©ë‹ˆë‹¤!
            body: new URLSearchParams({ phoneNumber: phoneNumber })
        })
        .then(response => response.text()) // json() ëŒ€ì‹  text()ë¡œ ë°›ê¸°
        .then(data => {
            console.log("ì„œë²„ ì‘ë‹µ ë°ì´í„°:", data);
            
            // ì„œë²„ì—ì„œ ë¦¬í„´í•œ ë¬¸ìì—´ì— 'ì„±ê³µ'ì´ë¼ëŠ” ê¸€ìê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            if (data.includes("ì„±ê³µ") || data === "Test OK") {
                resultMessage.style.color = 'blue';
                resultMessage.textContent = 'ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.';
                
                // ì—¬ê¸°ì— íƒ€ì´ë¨¸ ì‹œì‘ í•¨ìˆ˜ë¥¼ ë„£ìœ¼ë©´ ë”± ì¢‹ìŠµë‹ˆë‹¤!
                startTimer(); 
            } else {
                resultMessage.style.color = 'red';
                resultMessage.textContent = 'ë°œì†¡ ì‹¤íŒ¨: ' + data;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            resultMessage.textContent = 'ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        });
    });

    let timeLeft = 180; // 3ë¶„
    let timerInterval;

    function startTimer() {
        //document.getElementById('authSection').style.display = 'block'; // ì…ë ¥ì°½ ë³´ì´ê¸°
        const authCodeGroup = document.getElementById('authCodeGroup');

        clearInterval(timerInterval);
        authCodeGroup.classList.remove('hidden');

        timerInterval = setInterval(() => {
            let minutes = Math.floor(timeLeft / 60);
            let seconds = timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                alert("ì¸ì¦ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
            timeLeft--;
        }, 1000);
    }

    // ì¸ì¦í™•ì¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.getElementById('verifyBtn').addEventListener('click', () => {
        const inputCode = document.getElementById('authCode').value;
        const phoneNumber = document.getElementById('phoneNumber').value;

        fetch('/auth/verifyCode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded', ...requestHeaders },
            body: new URLSearchParams({ phoneNumber: phoneNumber, inputCode: inputCode })
        })
        .then(res => res.text())
        .then(data => {
            if (data === "ì¸ì¦ ì„±ê³µ") {
                alert("âœ… ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤!");
                clearInterval(timerInterval);
                resultMessage.textContent = "ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤.";

                // ì¶”ê°€ë¡œ ì¸ì¦ë²ˆí˜¸ ì…ë ¥ì°½ê³¼ ë²„íŠ¼ì„ ë¹„í™œì„±í™”í•˜ê±°ë‚˜ ìˆ¨ê¸¸ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
                document.getElementById('phoneNumber').disabled = true;
                document.getElementById('sendCode').disabled = true;
                document.getElementById('authCode').disabled = true;
                document.getElementById('verifyBtn').disabled = true;

                // ë‹¤ìŒ ë‹¨ê³„(íšŒì›ê°€ì… ì™„ë£Œ ë“±)ë¡œ ì§„í–‰
            } else {
                alert(data);
            }
        });
    });

    function togglePasswordVisibility(fieldId) {
            const passwordField = document.getElementById(fieldId);
            const toggleButton = passwordField.nextElementSibling; // ë°”ë¡œ ë‹¤ìŒ í˜•ì œ ìš”ì†Œ (ğŸ‘ï¸ ë²„íŠ¼)

            if (passwordField.type === "password") {
                passwordField.type = "text"; // ë¹„ë°€ë²ˆí˜¸ ë³´ì´ê²Œ
                toggleButton.textContent = "ğŸ”’"; // ì•„ì´ì½˜ ë³€ê²½ (ì„ íƒ ì‚¬í•­)
            } else {
                passwordField.type = "password"; // ë¹„ë°€ë²ˆí˜¸ ìˆ¨ê¸°ê²Œ
                toggleButton.textContent = "ğŸ‘ï¸"; // ì•„ì´ì½˜ ë³€ê²½ (ì„ íƒ ì‚¬í•­)
            }
        }
</script>
</body>
</html>
<!-- ğŸ“‚ ê²½ë¡œ: bdgd_user/src/main/resources/templates/join.html -->