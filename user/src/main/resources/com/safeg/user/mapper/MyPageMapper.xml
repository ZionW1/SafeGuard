<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.safeg.user.mapper.MyPageMapper">

    <select id="getAppliedDatesForUser" resultType="java.time.LocalDate">
        SELECT 
            applied_str_date,
            applied_end_date
        FROM user_campaign
        WHERE user_id = #{userId}
        AND status = '0' <!-- 신청 중인 상태의 날짜만 -->
        AND applied_str_date BETWEEN #{startDate} AND #{endDate}
        AND applied_end_date BETWEEN #{startDate} AND #{endDate}

    </select>

    <select id="getCompletedDatesForUser" resultType="CalendarEventVO">
        SELECT
            <!-- title, -->
            user_id,
            DATE_FORMAT(event_str_date, '%Y-%m-%d') start,
            <!-- DATE_FORMAT(event_end_date, '%Y-%m-%d') end, -->
            DATE_FORMAT(event_end_date + INTERVAL 1 DAY, '%Y-%m-%d') end,
            status,
            DATE_FORMAT(apply_date + INTERVAL 1 DAY, '%Y-%m-%d') apply_date
        FROM 
            user_campaign
        WHERE 
            user_id = #{userId}
        AND event_str_date BETWEEN #{startDate} AND #{endDate}
        AND event_end_date BETWEEN #{startDate} AND #{endDate}

    </select>

    <select id="getAddress" resultType="UserAddressVO">
        SELECT
            full_address
        FROM 
            user_address
        WHERE 
            user_id = #{id}
        AND
            is_deleted = 'N'
    </select>

    <update id="updateAddress">
        UPDATE user_address 
        SET 
            is_deleted = 'Y'
        WHERE user_id= #{id}
    </update>
    <insert id="insertAddress">
        INSERT INTO user_address (
            user_id, 
            zone_code, 
            province, 
            city, 
            road_name,
            road_address, 
            jibun_Address,
            extra_address,
            detail_address, 
            is_default,
            full_address
        )
        VALUES (
            #{id}, 
            #{zoneCode}, 
            #{province}, 
            #{city}, 
            #{roadName},
            #{roadAddress}, 
            #{jibunAddress},
            #{extraAddress},
            #{detailAddress}, 
            #{isDefault},
            #{fullAddress}
        )
    </insert>

    <update id="updateInfo">
        UPDATE user set 
            nickname = #{nickname},
            email = #{email},
            phone_num = #{phoneNum},
            bank_nm = #{bankNm},
            account_Number = #{accountNumber},
            depositor = #{depositor},
            updated_at = now()
        WHERE id= #{id}
    </update>

    <select id="pointList" resultType="UserCampaignVO">
        SELECT 
            uc.user_id,
            (CASE
                WHEN uc.status = '0' THEN '대기'
                WHEN uc.status = '1' THEN '출근'
                WHEN uc.status = '2' THEN '퇴근'
                WHEN uc.status = '3' THEN '지각'
                WHEN uc.status = '4' THEN '결근'
                WHEN uc.status = '5' THEN '무단'
                ELSE '없음'
            END) as status_nm,
            c.campaign_pay,
            apply_date,
            c.campaign_title,
            u.pay,
            c.leader_code,
            u.auth_id
            FROM user_campaign uc
        LEFT OUTER JOIN
        campaign c 
        ON uc.campaign_id = c.campaign_id
        LEFT OUTER JOIN
        user u
        ON uc.user_no = u.id
        WHERE uc.user_no =#{id}
		AND uc.is_DELETED ='N'
        AND uc.status = '2'
        ORDER BY
        apply_date desc
    </select>

    <select id="referrerPayList" resultType="UserCampaignVO">
        SELECT
            <!-- u.user_id AS giverUserId, -->
            u.user_nm AS user_nm,
            COUNT(ph.point_id) AS referrer_count,
            SUM(ph.amount) AS total_amount
        FROM
            point_history ph
        JOIN
            user u 
        ON 
            ph.source_id = u.id
        WHERE
            ph.point_type = 'REFERRAL_REWARD'
        AND ph.user_id = #{id}
        GROUP BY
            ph.source_id, u.user_id, u.user_nm
        ORDER BY
            referrer_count DESC
    </select>

    <select id="leaderPayList" parameterType="map" resultType="UserCampaignVO">
        <!-- SELECT
            c.campaign_title,
            count(uc.id) AS count,
            count(uc.status) * c.leader_point AS leader_point
        FROM 
            user_campaign uc
        LEFT OUTER JOIN 
            campaign c ON uc.campaign_id = c.campaign_id
        WHERE 
            uc.apply_date BETWEEN #{params.startDate} AND #{params.endDate}
        AND uc.campaign_id IN
            <foreach collection="params.campaignIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        AND status = '2'
        AND uc.is_leader = 'N'
        GROUP BY c.campaign_title, c.leader_point -->

        SELECT
            c.campaign_title,
            COUNT(uc.id) AS countUser,
            COUNT(*) * c.leader_point AS leader_point
        FROM user_campaign uc
        LEFT OUTER JOIN campaign c 
        ON uc.campaign_id = c.campaign_id
        WHERE uc.apply_date BETWEEN #{params.startDate} AND #{params.endDate}
        AND uc.campaign_id IN 
            <foreach collection="params.campaignIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        AND uc.status = '2'
        AND uc.is_leader = 'N'
        AND c.leader_code = #{params.id}
        GROUP BY c.campaign_title, c.leader_point;
    </select>

    <update id="applyBodyguard">
        UPDATE user set
            guard_type = #{guardType},
            updated_at = now()
        WHERE id= #{id}
    </update>

    <!-- findUserById 쿼리: 사용자 ID로 비밀번호를 포함한 사용자 정보 조회 -->
    <!-- 여기서는 UserVO의 모든 필드를 가져와도 되고, id와 password만 가져와도 됨 -->
    <select id="findUserById" resultType="com.safeg.user.vo.UserVO">
        SELECT 
            id, password
        FROM user
        WHERE id = #{userId}
    </select>

    <!-- updatePassword 쿼리: 새 비밀번호로 업데이트 -->
    <update id="updatePassword">
        UPDATE user
        SET password = #{encodedNewPassword},
            updated_at = NOW()
        WHERE id = #{userId}
    </update>

    <select id="campaignId" resultType="com.safeg.user.vo.UserCampaignVO">
        SELECT 
            campaign_id,
            user_id,
            user_no,
            status,
            apply_date
        FROM 
            user_campaign
        WHERE 
            user_no = #{id}
        AND is_leader = 'Y'
        AND is_deleted = 'N'
    </select>

    <select id="pointFull">
        SELECT 
            point_full
        FROM 
            user
        WHERE 
            id = #{id}
        AND is_deleted = 'N'
    </select>
</mapper>