<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
                xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
                layout:decorate="~{layouts/base_layout}"><head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>캠페인 신청 안내</title>
<link rel="stylesheet" href="/css/style.css" />
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<link href='/css/style.css' rel='stylesheet' />
<!-- FullCalendar JS -->
<style>
    
    .container {
        display: flex;
        gap: 40px;
        max-width: 90%;
        margin: 0 auto;
    }
    .left-view, .right-view {
        background: #fff;
        box-shadow: 0 0 12px rgb(0 0 0 / 0.05);
        border-radius: 20px;
        padding: 24px 32px;
    }
    .left-view {
        flex: 2;
    }
    .right-view {
        flex: 1;
        max-width: 450px;
    }
    /* .campaignTitle{
        font-size: 40px;
        margin-bottom: 20px;
    } */
    /* 이미지 영역 */
    .image-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    .image-row img {
        max-width: 100%; 
        height: 800px;
        height: -webkit-fill-available;
        border-radius: 16px;
        object-fit: cover;
    }

    /* 제공내역 */
    .section-title {
        font-weight: 700;
        font-size: 1rem;
        margin-top: 20px;
        margin-bottom: 10px;
    }
    .highlight-pink {
        color: #e12e76;
        font-weight: 700;
    }
    .content-text {
        font-size: 0.9rem;
        line-height: 1.4;
        color: #666;
    }
    .content-text small {
        display: block;
        margin-top: 6px;
    }
    hr {
        margin: 30px 0;
        border-color: #eee;
    }

    /* 방문안내 */
    .visit-info p {
        font-size: 0.85rem;
        line-height: 1.3;
        color: #666;
        margin: 8px 0;
    }
    .visit-info strong {
        color: #333;
    }
    .visit-info .bullet {
        margin-right: 5px;
    }

    /* 주소 */
    .address {
        margin-top: 20px;
        font-size: 0.9rem;
        color: #333;
    }

    /* 신청기간 및 달력 */
    .right-view h2 {
        font-weight: 800;
        font-size: 1.25rem;
        margin-bottom: 14px;
    }
    .right-view h2 .highlight-pink {
        font-weight: 900;
    }
    .right-view .period-info {
        font-size: 0.9rem;
        margin-bottom: 20px;
    }
    .period-info div {
        margin-bottom: 6px;
    }
    .period-info div span {
        margin-left: 8px;
        font-weight: 600;
    }
    .calendar-nav {
        text-align: center;
        margin-bottom: 14px;
    }
    .calendar-nav button {
        border: none;
        background: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: #666;
        padding: 0 10px;
    }
    .calendar-month {
        font-weight: 700;
        font-size: 1rem;
    }

    table.calendar {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    table.calendar th,
    table.calendar td {
        width: 14.28%; /* 7일체크 */
        text-align: center;
        font-size: 0.9rem;
        padding: 6px 0;
        color: #999;
    }
    table.calendar th {
        color: #aaa;
        font-weight: 600;
    }
    table.calendar td.active,
    table.calendar td.today {
        color: #333;
        font-weight: 600;
    }
    table.calendar td.weekend {
        color: #d84f42;
        font-weight: 600;
    }
    table.calendar td.saturday {
        color: #2972ff;
        font-weight: 600;
    }
    table.calendar td.apply-day {
        background: #f5f1f5;
        border-radius: 12px;
        font-weight: 700;
    }

    .btn-apply {
        width: 100%;
        background-color: #111;
        color: white;
        border: none;
        font-weight: 700;
        font-size: 1rem;
        padding: 12px 0;
        border-radius: 16px;
        cursor: pointer;
    }
    .calendar-day {
        position: relative;
        width: 40px;
        height: 40px;
        text-align: center;
        vertical-align: middle;
        cursor: pointer;
    }
    .application-period {
        background-color: #66666688; /* 반투명 회색 */
    }
    .announcement-day {
        background-color: #d5a8ee; /* 연보라색 */
        border-radius: 50%;
    }
    .experience-period {
        background-color: #d1d2db; /* 연회색 */
    }
    .fc-view-harness fc-view-harness-active{
        height: 450px;
    }
    #calendar {
        width: 100%;  /* 너비는 컨테이너에 맞게 조절 */
        max-width: 900px;  /* 필요에 따라 최대 너비 지정 */
        margin: 0 auto;  /* 가운데 정렬 */
    }

    .fc-prev-button,
    .fc-next-button {
        font-size: 1rem;
        padding: 0.4em 0.8em;
        height: 36px;
        line-height: 1.2;
        display: flex;
        align-items: center;
        justify-content: center;
        vertical-align: middle;
        margin: 0 4px;
        box-sizing: border-box;
    }


    .fc-icon-chevron-left::before,
    .fc-icon-chevron-right::before {
        font-size: 1.2rem;
    }
</style>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js'></script> <!-- 한글 지원을 위해 -->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=1e252ff5c2580391cd0d99d3ab30d182&libraries=services&autoload=false"></script>
<!-- <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=인증키&libraries=services,clusterer,drawing"></script> -->
<script>
    // 카카오 맵 API 로드가 완료되면 지도를 초기화하는 함수
    
</script>
<script th:inline="javascript">
    let campaign = /*[[${campaignSelect}]]*/ null;
    console.log("campaign : " + JSON.stringify(campaign))
    document.addEventListener('DOMContentLoaded', function() {
        kakao.maps.load(function() {
        // var container = document.getElementById('map');
        // var options = {
        //     center: new kakao.maps.LatLng(33.450701, 126.570667),
        //     level: 3
        // };

        // var map = new kakao.maps.Map(container, options);

        // // 마커가 표시될 위치입니다 
        // var markerPosition  = new kakao.maps.LatLng(33.450701, 126.570667); 

        // // 마커를 생성합니다
        // var marker = new kakao.maps.Marker({
        //     position: markerPosition
        // });

        // // 마커가 지도 위에 표시되도록 설정합니다
        // marker.setMap(map);



        var xx = "";
        var yy = "";
        
        // 주소-좌표 변환 객체를 생성합니다
        var geocoder = new kakao.maps.services.Geocoder();

        // 주소로 좌표를 검색합니다
        geocoder.addressSearch(campaign.placeAddr, function(result, status) {
            // 정상적으로 검색이 완료됐으면 
                if (status === kakao.maps.services.Status.OK) {

                    xx = result[0].x;
                    yy = result[0].y;
                    
                    console.log("yyyyyy : " + yy);
                    console.log("xxxxxx : " + xx);
                    
                    
                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                // 결과값으로 받은 위치를 마커로 표시합니다
                var marker = new kakao.maps.Marker({
                    map: map,
                    position: coords
                });

                // 인포윈도우로 장소에 대한 설명을 표시합니다
                var infowindow = new kakao.maps.InfoWindow({
                    content: '<div style="width:150px;text-align:center;padding:6px 0;">주소지</div>'
                });
                infowindow.open(map, marker);

                // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
                map.setCenter(coords);
            } 
        }); 
        
        
        var container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
        var options = { //지도를 생성할 때 필요한 기본 옵션
            center: new kakao.maps.LatLng(yy, xx), //지도의 중심좌표.
            level: 3 //지도의 레벨(확대, 축소 정도)
        };

        var map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴
    });

    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth', // 월별 보기
        locale: 'ko', // 한국어 설정
        headerToolbar: {
            right: 'prev next today',
            
        },
        height: 600,
        events: function(fetchInfo, successCallback, failureCallback) {
            console.log("cmpaign.apapPeriodStr + "  + campaign.campaignId);
            // Spring Boot 백엔드 API 호출
            fetch("/campaign07?id=" + campaign.campaignId)
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    // 데이터베이스에서 가져온 JSON 데이터를 FullCalendar 이벤트 형식으로 변환하여 전달
                    // (백엔드에서 이미 변환했다면 바로 successCallback(data) 호출)그리고 event날짜랑 event 없는 날짜랑 크기를 똑같이 하고 싶어
                    let events = [];
            // data가 유효한 객체인지 확인
            if (data && typeof data === 'object') { 
                // data가 배열이 아닌 단일 객체인 경우
                // FullCalendar는 이벤트를 배열 형태로 기대하므로, 단일 객체를 배열에 담아서 전달
                // events.push({
                //     // campaignTitle 또는 원하는 다른 필드를 title로 사용
                //     title: '신청일', // 달력에 표시될 제목
                //     start: data.appPeriodStr,
                //     end: data.appPeriodEnd,
                //     // 다른 필요한 정보들을 추가할 수 있어 (예: url, description 등)
                // });
                 // 1. 신청 기간 (appPeriodStr ~ appPeriodEnd)
                if (data.appPeriodStr && data.appPeriodEnd) {
                    let appEndDate = new Date(data.appPeriodEnd); // 'YYYY-MM-DD' 문자열을 Date 객체로 변환
                    appEndDate.setDate(appEndDate.getDate() + 1); // 현재 Date 객체에 하루를 더해줘
                    let formattedAppEndDate = appEndDate.toISOString().slice(0, 10); 

                    events.push({
                        title: '신청 기간', // 이 기간의 제목
                        start: data.appPeriodStr,
                        end: formattedAppEndDate,
                        color: '#4285F4', // 파란색 (구분하기 위해)
                        extendedProps: { // 추가 정보를 여기에 넣을 수 있어
                            type: '신청'
                        }
                    });
                }

                // 2. 이벤트 진행 기간 (eventPeriodStr ~ eventPeriodEnd)
                // campaignVO에 eventPeriodStr, eventPeriodEnd 필드가 있다면 활용
                if (data.eventPeriodStr && data.eventPeriodEnd) {
                    let appEndDate = new Date(data.eventPeriodEnd); // 'YYYY-MM-DD' 문자열을 Date 객체로 변환
                    appEndDate.setDate(appEndDate.getDate() + 1); // 현재 Date 객체에 하루를 더해줘
                    let formattedAppEndDate = appEndDate.toISOString().slice(0, 10); 

                    events.push({
                        title: '이벤트 진행', // 이 기간의 제목
                        start: data.eventPeriodStr,
                        end: formattedAppEndDate,
                        color: '#DB4437', // 빨간색 (구분하기 위해)
                        extendedProps: {
                            type: '진행'
                        }
                    });
                }
                
                // 3. 결과 발표일 (resultDate)
                // campaignVO에 resultDate 필드가 있다면 활용
                

                // 여기에 campaignVO 내에 다른 날짜 관련 필드가 더 있다면,
                // 위와 같은 방식으로 if문과 push를 사용하여 추가하면 돼!
            } else {
                console.warn('Server response for /campaignSelect was not a valid object:', data);
            }
                    successCallback(events);
                })
                .catch(error => {
                    console.log('Error fetching events:' + error);
                    failureCallback(error);
                });
        }
        // 다른 FullCalendar 옵션들 (예: 클릭 이벤트, 드래그앤드롭 등)
    });
    calendar.render();

        // let whiteSal = campaign.whiteSal;
        // let greenSal = campaign.greenSal;
        // let yellowSal = campaign.yellowSal;
        // let orangeSal = campaign.orangeSal;
        // let redSal = campaign.redSal;

        // let whFormatted = whiteSal.toLocaleString('ko-KR'); // 결과: "10,000"
        // let grFormatted = greenSal.toLocaleString('ko-KR'); // 결과: "10,000"
        // let yeFormatted = yellowSal.toLocaleString('ko-KR'); // 결과: "10,000"
        // let orFormatted = orangeSal.toLocaleString('ko-KR'); // 결과: "10,000"
        // let reFormatted = redSal.toLocaleString('ko-KR'); // 결과: "10,000"

        // document.getElementById("whiteSal").textContent = whFormatted;
        // document.getElementById("greenSal").textContent = grFormatted;
        // document.getElementById("yellowSal").textContent = yeFormatted;
        // document.getElementById("orangeSal").textContent = orFormatted;
        // document.getElementById("redSal").textContent = reFormatted;

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        console.log(today)
        const badge = document.querySelector('.d-Day'); // 요소가 하나일 때
        console.log("badge + " + badge);
        if (badge) {
            const dateStr = badge.dataset.eventEndDateStr;
            console.log("dataStr : " + dateStr)

            if (!dateStr) {
                badge.textContent = '기간 미정';
            } else {
                const eventDate = new Date(dateStr.replace(/\./g, '/'));
                eventDate.setHours(0, 0, 0, 0);
                if (isNaN(eventDate.getTime())) {
                    badge.textContent = '날짜 오류';
                } else {
                    const diffDays = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
                    if (diffDays === 0) {
                        badge.textContent = `오늘이 신청 마지막 날이에요.`;
                        badge.classList.add('today');
                    } else if (diffDays > 0) {
                        badge.textContent = `신청기간이 D-${diffDays} 남았어요`;
                    } else {
                        badge.textContent = '마감됨';
                    }
                }
            }
        }
    });
    function login(){
        console.log("aa");
        var link = '/user01';
        location.href=link;
    }
    
            // document.querySelectorAll('.d-Day').forEach(function(badge) {
            //     const dateStr = badge.dataset.eventEndDateStr; // ${item.eventPeriodEnd != null ? #temporals.format(item.eventPeriodEnd, 'yyyy/MM/dd') : ''}
            //     console.log("dataStr : " + dateStr)
            //     if (!dateStr) {
            //     badge.textContent = '기간 미정';
            //     return;
            //     }
            //     const eventDate = new Date(dateStr.replace(/\./g, '/'));
            //     eventDate.setHours(0, 0, 0, 0);
            
            //     if (isNaN(eventDate.getTime())) {
            //     badge.textContent = '날짜 오류';
            //     return;
            //     }
            
            //     const diffDays = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
            //     if (diffDays === 0) {
            //     badge.textContent = '오늘마감';
            //     badge.classList.add('today');
            //     } else if (diffDays > 0) {
            //     badge.textContent = `D-${diffDays}`;
            //     } else {
            //     badge.textContent = '마감됨';
            //     }
            // });

</script>
</head>
<body>
    <main layout:fragment="content">
    <div class="container">
    <section class="left-view">
        <div class="campaignTitle">
            <!-- <span>캠페인 명 : </span><span th:text="${campaignSelect.campaignTitle}"></span> -->
            <h1 th:text="${campaignSelect.campaignTitle}"></h1>
        </div>
        
        <div class="image-row">
            <!-- 이미지 경로는 마이클 환경에 맞게 수정해주세요 -->
            <img id="imgFile" th:src="|/img?id=${campaignSelect.campaignId}|" alt="파일이미지" width="1024" height="720" class=""/><br>
            <!-- <img src="image2.jpg" alt="음식 이미지 2" /> -->
        </div>

        <div class="section-title">
            모집인 <span class="highlight-pink">총 <span th:text="${campaignSelect.applicantsNum}"></span> / <span th:text="${campaignSelect.recruitmentNum}"></span>명</span>
        </div>
        

        <hr />

        <h2 class="">안내 사항</h2>
        <div class="visit-info">
            <div>
                <pre th:text="${campaignSelect.mission}"></pre>
            </div>
        </div>

        <div class="section-title address">
            주소
        </div>
        <div class="content-text">
            <span th:text="${campaignSelect.placeAddr}"></span>
        </div>
        <div class="map">
            <div class="col-6">
                <div class="map_area  mb20" id="map" style="width:100%; height:350px;"></div>
            </div>
        </div>
    </section>

    <section class="right-view">
        
        <h2><span class="d-Day"th:data-event-end-date-str="${campaignSelect.appPeriodEnd != null ? #temporals.format(campaignSelect.appPeriodEnd, 'yyyy-MM-dd') : ''}"
            th:data-campaign-id="${campaignSelect.campaignId}"></span></h2>
        <div class="period-info">
            <div>신청기간 : <span th:text="${campaignSelect.appPeriodStr}"></span> ~<span th:text="${campaignSelect.appPeriodEnd}"></span></div>
            <div>결과발표 : <span th:text="${campaignSelect.resultDate}">11.03</span></div>
            <div>날짜 : <span th:text="${campaignSelect.eventPeriodStr}"></span> ~<span th:text="${campaignSelect.eventPeriodEnd}"></span></div>
        <br>
        <div id="calendar">
            <!-- 달력 날짜는 자바스크립트로 동적으로 생성 가정 -->
        </div>
        <h1>인솔자 사진</h1>
        <div class="image-row">
            <!-- 이미지 경로는 마이클 환경에 맞게 수정해주세요 -->
            <img id="imgFile" th:src="|/selectProfile?id=${campaignSelect.leaderCode}&args=profile|" alt="파일이미지" width="400" height="400" class=""/><br>
            <!-- <img src="image2.jpg" alt="음식 이미지 2" /> -->
        </div>
    </div>

    <form id="form" class="" action="/apply" method="post">
        
        <div sec:authorize="!isAuthenticated()" class="guest-message">
            <button class="btn-apply" type="button" onclick="login()">로그인하고 캠페인 신청하기</button>
        </div>
        <div sec:authorize="isAuthenticated()" class="guest-message">
            <div class="" th:each="campaign : ${campaignApply}">
                <!-- ⭐ isApplyPossible 값이 true일 때만 신청 버튼을 보여줍니다! ⭐ -->
                <a th:if="${campaign.eventActive}"
                    th:href="@{/campaign/apply/{id}(id=${campaign.campaignId})}"
                    class="btn-apply">
                    신청하기
                </a>
            
                <!-- 신청 불가능할 때 (기간이 겹치거나 날짜 정보가 없거나) -->
                <div th:unless="${campaign.eventActive}" class="campaign-status-unavailable">
                    신청 불가 (기간 중복)
                </div>
            
                <!-- "상세보기" 버튼은 보통 기간이 겹쳐도 보이게 하는 경우가 많지만, 숨기고 싶다면 위와 같은 로직으로 제어 -->
                <!-- <a th:href="@{/campaign/detail/{id}(id=${campaign.campaignId})}" class="btn-detail">
                    &gt;
                </a> -->
            </div>


            <div th:if="${campaignApply == null}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="userNo" th:value="${user.id}">
                <input type="hidden" name="userId" th:value="${user.userId}">
                <input type="hidden" name="campaignId" th:value="${campaignSelect.campaignId}">
                <input type="hidden" name="applicantsNum" th:value="${campaignSelect.applicantsNum}">
                <input type="hidden" name="eventPeriodStr" th:value="${campaignSelect.eventPeriodStr}">
                <input type="hidden" name="eventPeriodEnd" th:value="${campaignSelect.eventPeriodEnd}">
                <button class="btn-apply" type="submit">신청하기</button>
            </div>
            <div th:if="${campaignApply != null}">
                <span>신청 했습니다.</span>
            </div>
        </div>
    </form>
    </section>
    </div>
    </main>
</body>
</html>