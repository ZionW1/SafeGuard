<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
                xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
                layout:decorate="~{layouts/base_layout}"><head>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/css/style.css" />
    <style>
    h1 {
      font-size: 1.5rem;
      font-weight: 700;
    }
    .mypage_form {
      max-width: 55%;
      margin: auto;
    }
    
    .section-title {
        width: 80%;
      margin-top: 30px;
      margin-bottom: 10px;
      font-weight: 700;
      font-size: 1.1rem;
      border-bottom: 2px solid #555;
      padding-bottom: 2px;
    }
    .form-row {
        width: 70%;
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 15px;
        align-items: center;
    }
    label {
      width: 130px;
      font-weight: 600;
      color: #222;
    }
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="tel"] {
      flex: 1;
      padding: 15px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    input[readonly] {
      background-color: #f0f0f0;
      cursor: not-allowed;
    }
    .mypage_button {
      margin-top: 00px;
      padding: 10px 20px;
      font-size: 1.1rem;
      border: none;
      border-radius: 5px;
      background-color: #f09a67;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #e28342;
    }
    .left-container {
    display: flex;
    flex-direction: column;  /* 세로 정렬 (이미지 위, 텍스트 아래) */
    align-items: center;     /* 가로 중심 정렬 */
    justify-content: center; /* 세로 중심 정렬 */
    height: 100%;            /* 부모 컨테이너 높이에 맞춤 (필요에 따라 조절) */
    width: 100%;             /* 부모 컨테이너 너비에 맞춤 */
    box-sizing: border-box;  /* 패딩, 보더 포함 */
    padding: 10px;           /* 영역 내 간격 */
    }
    .mypage_address {
        margin-right: 5px;
    }
    .zone_code {
        width: 100px;
    }
    </style>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <script th:inline="javascript">
    const csrfToken = /*[[${_csrf.token}]]*/ '';
    const csrfHeaderName = /*[[${_csrf.headerName}]]*/ '';

    async function changePassword() {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmPassword').value;

        // --- 클라이언트 측 유효성 검사 ---
        let isValid = true;
        
        // 에러 메시지 초기화
        document.getElementById('currentPasswordError').textContent = '';
        document.getElementById('newPasswordError').textContent = '';
        document.getElementById('confirmNewPasswordError').textContent = '';

        if (!currentPassword) {
            document.getElementById('currentPasswordError').textContent = '현재 비밀번호를 입력해 주세요.';
            isValid = false;
        }
        
        if (!newPassword) {
            document.getElementById('newPasswordError').textContent = '새 비밀번호를 입력해 주세요.';
            isValid = false;
        } else if (newPassword.length < 8) { // 최소 8자 이상
            document.getElementById('newPasswordError').textContent = '새 비밀번호는 최소 8자 이상이어야 합니다.';
            isValid = false;
        }
        // 여기에 더 복잡한 비밀번호 정책 추가 가능 (대소문자, 숫자, 특수문자 등)
        // 예: if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}/.test(newPassword)) { ... }

        if (newPassword !== confirmNewPassword) {
            document.getElementById('confirmNewPasswordError').textContent = '새 비밀번호가 일치하지 않습니다.';
            isValid = false;
        }

        if (currentPassword === newPassword && newPassword !== '') { // 현재 비밀번호와 새 비밀번호가 같은지 확인 (단, 비어있지 않을 때)
            document.getElementById('newPasswordError').textContent = '현재 비밀번호와 다른 비밀번호를 사용해 주세요.';
            isValid = false;
        }

        if (!isValid) {
            return; // 유효성 검사 실패 시 전송 중단
        }

        // --- 백엔드로 데이터 전송 ---
        const formData = new URLSearchParams();
        formData.append('currentPassword', currentPassword);
        formData.append('newPassword', newPassword);

        const requestHeaders = {};
        if (csrfHeaderName && csrfToken) {
            requestHeaders[csrfHeaderName] = csrfToken;
        }
        console.log("formData: " + formData.toString());
        requestHeaders['Content-Type'] = 'application/x-www-form-urlencoded;charset=UTF-8'; // FormData를 URLSearchParams로 보낼 때 필요

        try {
            const response = await fetch('/mypage/changePassword', { // 백엔드 URL
                method: 'POST',
                headers: requestHeaders,
                body: formData
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || `HTTP error! Status: ${response.status}`);
            }

            const result = await response.json();
            if (result.success) {
                alert('비밀번호가 성공적으로 변경되었습니다!');
                // 성공 시 페이지 새로고침 또는 로그인 페이지로 리다이렉트
                window.location.reload(); 
            } else {
                // 서버에서 보낸 에러 메시지 표시
                alert('비밀번호 변경 실패: ' + (result.message || '알 수 없는 오류 발생'));
            }
        } catch (error) {
            console.error('비밀번호 변경 중 오류 발생:', error);
            alert('비밀번호 변경 중 클라이언트/네트워크 오류: ' + error.message);
        }
    }
    </script>
    
    <script th:inline="javascript">
        // const isAuthenticated = document.getElementById('isAuthenticated').value === 'true';

        // let user = /*[[${user}]]*/ null;
        // document.addEventListener('DOMContentLoaded', function() {
        //     console.log("user : " + user);
        // });
    </script>
</head>

<body>
    <!-- <div sec:authorize="isAuthenticated()">
        <h3>인증된 사용자 디버그 정보:</h3>
        <p>Principal 클래스명: <span th:text="${#authentication.principal.getClass().getName()}"></span></p>
        <p>Principal 전체 정보: <span th:text="${#authentication.principal.toString()}"></span></p>
        <p>Username (sec:authentication="name"): <span sec:authentication="name"></span></p>
        여기에 th:text="${#authentication.principal.id}" 추가해보기
        <p>ID (principal.id): <span th:text="${#authentication.principal.id}"></span></p>
    </div> -->
    <main layout:fragment="content">
        <div class="main-side-content">
            <div class="container">
                <th:block th:replace="~{fragments/mypageSidebar :: mypageSidebarMenu}" />
            </div>
            <div class="main-content">
                <form class="mypage_form" id="form" action="/mypage/updateInfo" method="post" enctype="multipart/form-data">

                <div class="section-title">비밀번호 변경</div>
                <div class="form-row">
                    <label for="currentPassword">기존 비밀번호</label>
                    <input type="password" id="currentPassword" name="currentPassword" placeholder="영문, 숫자, 특수문자 조합 10자 이상" />
                    <div id="currentPasswordError" class="text-danger small"></div>
                </div>
                <div class="form-row">
                    <label for="newPassword">새 비밀번호</label>
                    <input type="password" id="newPassword" name="newPassword" placeholder="영문, 숫자, 특수문자 조합 10자 이상" />
                    <div id="newPasswordError" class="text-danger small"></div>
                </div>
                <div class="form-row">
                    <label for="confirmPassword">새 비밀번호 확인</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" />
                    <div id="confirmNewPasswordError" class="text-danger small"></div>
                </div>
                <button class="mypage_button" type="button" onclick="changePassword()">비밀번호 변경</button>
                        <!-- <div class="form-group">
                            <label for="currentPassword">현재 비밀번호</label>
                            <input type="password" id="currentPassword" name="currentPassword" class="form-control" required>
                            <div id="currentPasswordError" class="text-danger small"></div>
                        </div>
                        <div class="form-group mt-3">
                            <label for="newPassword">새 비밀번호</label>
                            <input type="password" id="newPassword" name="newPassword" class="form-control" required>
                            <div id="newPasswordError" class="text-danger small"></div>
                        </div>
                        <div class="form-group mt-3">
                            <label for="confirmNewPassword">새 비밀번호 확인</label>
                            <input type="password" id="confirmNewPassword" name="confirmNewPassword" class="form-control" required>
                            <div id="confirmNewPasswordError" class="text-danger small"></div>
                        </div>
                        <button type="button" class="btn btn-primary mt-4" onclick="changePassword()">비밀번호 변경</button> -->
                </form>
            </div>
        </div>
    
        <div id="address_modal_background" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
        background-color: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
            <div id="address_search_wrap" style="position:relative; width:90%; max-width:500px; height:460px; background:#fff; border-radius:8px; padding:10px; box-sizing: border-box;">
                <button onclick="foldDaumPostcode()" style="position:absolute; top:10px; right:10px; z-index:10; cursor:pointer;">✕</button>
            </div>
        </div>
        <!-- 로그인하지 않은 사용자에게 보이는 메시지 -->
        <div sec:authorize="!isAuthenticated()" class="guest-message">
            <p>로그인 후 마이페이지를 이용하실 수 있습니다.</p>
            <p><a th:href="@{/login}">로그인하기</a></p>
        </div>
    </div>
</main>
</body>
</html>